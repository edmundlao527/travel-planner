<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ—…éŠè³‡è¨Š - æ—…éŠåŠ©æ‰‹</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ===== æ ¸å¿ƒæ¨£å¼ ===== */
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; font-weight: 800; -webkit-tap-highlight-color: transparent; }
html, body { margin: 0; height: 100%; overflow: hidden; }
.main-container { height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 120px; position: relative; z-index: 1; }
.bg-fixed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image:url('images/info/infobg.jpeg'); background-size: cover; background-position: center; z-index: -1; }

header { padding: 16px; text-align: center; font-size: 20px; border-bottom: 3px solid #000; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); }

.filter-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 15px; background: rgba(255,255,255,0.7); border-bottom: 3px solid #000; scrollbar-width: none; }
.filter-scroll::-webkit-scrollbar { display: none; }
.filter-btn { flex-shrink: 0; padding: 8px 16px; border: 3px solid #000; background: #fff; box-shadow: 3px 3px 0 #000; font-size: 14px; }
.filter-btn.active { background: #ff8c00; color: #fff; }

.info-list { padding: 20px; }
.ticket-card { position: relative; background: #fff; border: 3px solid #000; margin-bottom: 25px; display: flex; flex-direction: column; box-shadow: 6px 6px 0 #000; overflow: hidden; }
.ticket-card::after { content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 10px; background-image: radial-gradient(circle, transparent 70%, #000 75%); background-size: 15px 15px; background-position: center bottom; }

.type-ribbon { position: absolute; top: 15px; left: -25px; width: 100px; padding: 4px; background: #000; color: #fff; text-align: center; transform: rotate(-45deg); font-size: 10px; z-index: 2; }

.ticket-main { padding: 25px 20px 20px 40px; }

.route-container { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; position: relative; }
.route-point { flex: 1; }
.route-arrow { flex: 0.4; display: flex; align-items: center; justify-content: center; position: relative; }
.route-line { width: 100%; border-top: 2px dashed #000; position: absolute; top: 50%; z-index: 1; }
.route-icon-box { background: #fff; position: relative; z-index: 2; padding: 0 5px; font-size: 18px; }

.ticket-divider { border-top: 3px dashed #000; margin: 0 15px; position: relative; }
.ticket-divider::before, .ticket-divider::after { content: ''; position: absolute; top: -10px; width: 20px; height: 20px; background: #eee; border: 3px solid #000; border-radius: 50%; }
.ticket-divider::before { left: -28px; }
.ticket-divider::after { right: -28px; }

.ticket-footer { padding: 15px 20px; background: #f9f9f9; display: flex; justify-content: space-between; align-items: center; }

.bg-icon {
  position: absolute; right: -5px; top: -5px; width: 100px; height: 100px;
  opacity: 0.12; transform: rotate(15deg); pointer-events: none; z-index: 0;
  background-size: contain; background-repeat: no-repeat; background-position: center;
}

.info-label { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
.info-value { font-size: 18px; color: #000; margin-bottom: 2px; }
.time-value { font-size: 14px; font-weight: 900; color: #ff8c00; }

.ticket-flight { border-left: 12px solid #3b82f6; }
.ticket-hotel { border-left: 12px solid #10b981; }
.ticket-car { border-left: 12px solid #f59e0b; }
.ticket-spot { border-left: 12px solid #a855f7; }

.add-fab { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; background: #ff8c00; border: 4px solid #000; border-radius: 50%; box-shadow: 5px 5px 0 #000; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #fff; z-index: 100; }

.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
.modal-content { width: 100%; max-width: 380px; background: #fff; border: 4px solid #000; box-shadow: 8px 8px 0 #000; padding: 20px; max-height: 90vh; overflow-y: auto; }
.input-group { border: 2px solid #eee; padding: 10px; margin-top: 10px; border-radius: 8px; }
.input-row { display: flex; gap: 8px; margin-top: 5px; }
select, input, textarea { width: 100%; border: 3px solid #000; padding: 10px; margin-top: 8px; font-size: 14px; font-weight: 800; }
.save-btn { width: 100%; padding: 15px; background: #000; color: #fff; border: 3px solid #000; margin-top: 15px; font-size: 16px; }
</style>
</head>

<body>

<div class="bg-fixed"></div>

<div class="main-container">
  <header>ğŸ« æ—…éŠæ†‘è­‰</header>

  <div class="filter-scroll">
    <div class="filter-btn active" onclick="setFilter('all', this)">å…¨éƒ¨</div>
    <div class="filter-btn" onclick="setFilter('flight', this)">âœˆï¸ ç¥¨åˆ¸</div>
    <div class="filter-btn" onclick="setFilter('hotel', this)">ğŸ¨ ä½å®¿</div>
    <div class="filter-btn" onclick="setFilter('car', this)">ğŸš— äº¤é€š</div>
    <div class="filter-btn" onclick="setFilter('spot', this)">ğŸŸï¸ é–€ç¥¨</div>
  </div>

  <div class="info-list" id="infoList"></div>
</div>

<div class="add-fab" onclick="openAddModal()">ï¼‹</div>

<div class="modal" id="addModal" onclick="if(event.target==this) closeAddModal()">
  <div class="modal-content">
    <h3 id="modalTitle" style="margin-top:0">æ–°å¢è³‡è¨Šå¡</h3>
    <input type="hidden" id="editId"> <select id="infoType" onchange="toggleInputs()">
      <option value="flight">âœˆï¸ æ©Ÿç¥¨ / è»Šç¥¨</option>
      <option value="hotel">ğŸ¨ ä½å®¿è³‡è¨Š</option>
      <option value="car">ğŸš— ç§Ÿè»Šäº¤é€š</option>
      <option value="spot">ğŸŸï¸ å…¥å ´é–€ç¥¨</option>
    </select>
    
    <input type="text" id="infoTitle" placeholder="æ¨™é¡Œ (å¦‚: CX504 / å¤§é˜ªæ´²éš›)">

    <div class="input-group">
      <div id="label1" class="info-label">é–‹å§‹è³‡è¨Š</div>
      <div class="input-row">
        <input type="text" id="startLoc" placeholder="åœ°é»/åŸå¸‚">
        <input type="text" id="startTime" placeholder="æ™‚é–“">
      </div>
    </div>

    <div class="input-group" id="endSection">
      <div id="label2" class="info-label">çµæŸè³‡è¨Š</div>
      <div class="input-row">
        <input type="text" id="endLoc" placeholder="åœ°é»/åŸå¸‚">
        <input type="text" id="endTime" placeholder="æ™‚é–“">
      </div>
    </div>

    <textarea id="infoDetail" placeholder="è©³ç´°å…§å®¹ / ç¢ºèªç¢¼..." rows="2"></textarea>
    <button class="save-btn" id="saveBtn" onclick="saveInfo()">å„²å­˜è¡Œç¨‹</button>
  </div>
</div>

<script>
const firebaseConfig = { apiKey: "AIzaSyASLSZHEKiQfUJU1c0sJ_9eH-6-9-1Rypc", authDomain: "tokyo-travel-share.firebaseapp.com", projectId: "tokyo-travel-share" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const typeMap = {
  flight: { label: 'Ticket', img:'images/info/air.png', class: 'ticket-flight', sLabel: 'From', eLabel: 'To', icon: 'âœˆï¸' },
  hotel: { label: 'Stay', img:'images/info/hotel.png', class: 'ticket-hotel', sLabel: 'Check-In', eLabel: 'Check-Out', icon: 'ğŸ¨' },
  car: { label: 'Drive',img:'images/info/tri.png', class: 'ticket-car', sLabel: 'Pick-Up', eLabel: 'Drop-Off', icon: 'ğŸš—' },
  spot: { label: 'Entry',img:'images/info/ticket.png', class: 'ticket-spot', sLabel: 'Date/Time', eLabel: '', icon: 'ğŸŸï¸' }
};

let currentFilter = 'all';
let allData = [];

function toggleInputs() {
  const type = document.getElementById('infoType').value;
  const config = typeMap[type];
  document.getElementById('label1').innerText = config.sLabel;
  document.getElementById('label2').innerText = config.eLabel;
  document.getElementById('endSection').style.display = (type === 'spot') ? 'none' : 'block';
}

function setFilter(type, el) {
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  renderData();
}

db.collection("travel_info").orderBy("startTime", "asc").onSnapshot(s => {
  allData = [];
  s.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
  renderData();
});

function renderData() {
  const listEl = document.getElementById('infoList');
  listEl.innerHTML = "";
  const filtered = currentFilter === 'all' ? allData : allData.filter(d => d.type === currentFilter);
  
  filtered.forEach(d => {
    const config = typeMap[d.type] || typeMap.flight;
    const isSingle = d.type === 'spot';
    const isFlight = d.type === 'flight';

    listEl.innerHTML += `
      <div class="ticket-card ${config.class}" onclick="editInfo('${d.id}')">
        <div class="type-ribbon">${config.label}</div>
        <div class="bg-icon" style="background-image: url('${config.img}')"></div>
        <div class="ticket-main">
          <div class="info-label">Title / Reference</div>
          <div class="info-value">${d.title}</div>
          <div class="route-container">
            <div class="route-point">
              <div class="info-label">${config.sLabel}</div>
              <div class="info-value" style="font-size:15px;">${d.startLoc || '-'}</div>
              <div class="time-value">${d.startTime || ''}</div>
            </div>
            ${!isSingle ? `
            <div class="route-arrow">
              ${isFlight ? `<div class="route-line"></div>` : ''}
              <div class="route-icon-box">${isFlight ? config.icon : 'â¯'}</div>
            </div>
            <div class="route-point" style="text-align:right;">
              <div class="info-label">${config.eLabel}</div>
              <div class="info-value" style="font-size:15px;">${d.endLoc || '-'}</div>
              <div class="time-value">${d.endTime || ''}</div>
            </div>
            ` : ''}
          </div>
        </div>
        <div class="ticket-divider"></div>
        <div class="ticket-footer">
          <div style="flex: 1;">
            <div class="info-label">Notes / Details</div>
            <div style="font-size: 13px;">${d.detail || ''}</div>
          </div>
          <button style="background:none; border:none; color:red; font-size:12px; position:relative; z-index:10;" onclick="event.stopPropagation(); deleteInfo('${d.id}')">åˆªé™¤</button>
        </div>
      </div>`;
  });
}

function openAddModal() {
  document.getElementById('modalTitle').innerText = "æ–°å¢è³‡è¨Šå¡";
  document.getElementById('editId').value = "";
  clearInputs();
  document.getElementById('addModal').style.display = 'flex';
  toggleInputs();
}

function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

// ç·¨è¼¯åŠŸèƒ½
function editInfo(id) {
  const item = allData.find(d => d.id === id);
  if(!item) return;

  document.getElementById('modalTitle').innerText = "ç·¨è¼¯è³‡è¨Šå¡";
  document.getElementById('editId').value = id;
  document.getElementById('infoType').value = item.type;
  document.getElementById('infoTitle').value = item.title;
  document.getElementById('startLoc').value = item.startLoc;
  document.getElementById('startTime').value = item.startTime;
  document.getElementById('endLoc').value = item.endLoc;
  document.getElementById('endTime').value = item.endTime;
  document.getElementById('infoDetail').value = item.detail;

  document.getElementById('addModal').style.display = 'flex';
  toggleInputs();
}

function saveInfo() {
  const id = document.getElementById('editId').value;
  const data = {
    type: document.getElementById('infoType').value,
    title: document.getElementById('infoTitle').value,
    startLoc: document.getElementById('startLoc').value,
    startTime: document.getElementById('startTime').value,
    endLoc: document.getElementById('endLoc').value,
    endTime: document.getElementById('endTime').value,
    detail: document.getElementById('infoDetail').value,
    updatedAt: Date.now()
  };

  if(!data.title) return alert("è«‹è¼¸å…¥æ¨™é¡Œ");

  if(id) {
    // æ›´æ–°èˆŠè³‡æ–™
    db.collection("travel_info").doc(id).update(data).then(() => closeAddModal());
  } else {
    // æ–°å¢è³‡æ–™
    data.createdAt = Date.now();
    db.collection("travel_info").add(data).then(() => closeAddModal());
  }
}

function clearInputs() {
  ['infoTitle', 'startLoc', 'startTime', 'endLoc', 'endTime', 'infoDetail'].forEach(id => document.getElementById(id).value = "");
}

function deleteInfo(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.collection("travel_info").doc(id).delete(); }
function fixHeight() { document.querySelector('.bg-fixed').style.height = window.innerHeight + 'px'; }
window.addEventListener('load', fixHeight);
window.addEventListener('resize', fixHeight);
</script>
</body>
</html>

