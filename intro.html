<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¡Œç¨‹ä»‹ç´¹ - æ—…éŠé›œèªŒ</title>

<style>
/* ===== å»¶çºŒä¸»è¦–è¦ºè¨­å®š ===== */
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; font-weight: 800; }

/* ä¿®æ­£èƒŒæ™¯è·³å‹•ï¼šå¾¹åº•å›ºå®šå±¤ */
.bg-fixed {
  position: fixed;
  /* ä½¿ç”¨è² å€¼å»¶ä¼¸é‚Šç•Œï¼Œé ç•™ç©ºé–“çµ¦å·¥å…·åˆ—ä¼¸ç¸® */
  top: -5%;
  left: -5%;
  width: 110%;
  height: 110%;
  
  background-image: url('images/intro/introbg.jpeg');
  background-size: cover;
  background-position: center;
  
  /* é—œéµï¼šå¼·åˆ¶ç¡¬é«”åŠ é€Ÿï¼Œé˜²æ­¢ç§»å‹•ç«¯æ¸²æŸ“é–ƒçˆ */
  transform: translate3d(0, 0, 0);
  -webkit-transform: translate3d(0, 0, 0);
  
  z-index: -1;
  pointer-events: none; /* ç¢ºä¿ä¸å½±éŸ¿é»æ“Š */
}

body {
  margin: 0;
  background: transparent; /* body è¨­ç‚ºé€æ˜ï¼Œä½¿ç”¨ bg-fixed çš„åº•åœ– */
  min-height: 100vh;
  padding-bottom: 50px;
}


header { padding: 16px; text-align: center; font-size: 22px; font-weight: 900; border-bottom: 3px solid #000; background: #fff; }

.filter-bar {
  display: flex;
  justify-content: flex-start; /* æ‰‹æ©Ÿæ»‘å‹•æ¨¡å¼å¿…é ˆé å·¦å°é½Š */
  flex-wrap: nowrap;           /* å¼·åˆ¶ä¸æ›è¡Œ */
  gap: 10px;
  padding: 12px 15px;
  overflow-x: auto;            /* é–‹å•Ÿæ©«å‘æ»‘å‹• */
  -webkit-overflow-scrolling: touch; /* å¢åŠ  iOS æ»‘å‹•æµæš¢åº¦ */
  position: sticky;
  top: 0;
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  z-index: 100;
  border-bottom: 3px solid #000;
}

.filter-bar::-webkit-scrollbar {
  display: none;
}

.filter-bar:first-of-type {
  position: sticky;
  top: 0;
  z-index: 101;
}

#regionBar {
  position: sticky;
  top: 53px; /* é€™è£¡çš„æ•¸å€¼è¦æ ¹æ“šä½ ç¬¬ä¸€æ’çš„é«˜åº¦èª¿æ•´ï¼Œç¢ºä¿å…©æ’è²¼åˆ */
  border-top: none;
  background: rgba(255,255,255,0.8);
  z-index: 100;
}

.filter-btn {
  flex-shrink: 0;              /* ç¢ºä¿æŒ‰éˆ•ä¸æœƒè¢«æ“ å£“è®Šå½¢ */
  min-width: fit-content;      /* å¯¬åº¦ä¾æ–‡å­—ç¸®æ”¾ */
  padding: 8px 16px;
  background: #fff;
  border: 3px solid #000;
  box-shadow: 3px 3px 0 #000;
  font-size: 14px;
}
.filter-btn.active { background: #ff8c00; color: #fff; }



.intro-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 16px;
}

.intro-card {
  background: #fff;
  border: 3px solid #000;
  box-shadow: 5px 5px 0 #000;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.intro-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
  border-bottom: 3px solid #000;
}

.intro-content { padding: 10px; }

.tag {
  display: inline-block;
  font-size: 10px;
  padding: 2px 6px;
  border: 2px solid #000;
  border-radius: 99px;
  margin-bottom: 5px;
}
.tag.spot { background: #bbf7d0; }
.tag.food { background: #fde68a; }
.tag.shopping { background: #fbcfe8; }

.intro-title { font-size: 16px; line-height: 1.2; margin-bottom: 5px; }

/* ===== Modal ===== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
  padding: 20px;
}
.modal-content {
  background: #fff;
  border: 4px solid #000;
  box-shadow: 8px 8px 0 #000;
  width: 100%;
  max-width: 400px;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #fff;
  border: 3px solid #000;
  width: 35px;
  height: 35px;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}
.modal-img { width: 100%; border-bottom: 3px solid #000; }
.modal-body { padding: 20px; }
.modal-desc { font-size: 14px; color: #444; line-height: 1.6; margin: 15px 0; font-weight: 500;}

.map-btn {
  display: block;
  text-align: center;
  padding: 12px;
  background: #000;
  color: #fff;
  text-decoration: none;
  border: 3px solid #000;
}

.add-fab {
  position: fixed;
  bottom: 25px;
  right: 25px;
  width: 60px;
  height: 60px;
  background: #ff8c00;
  border: 3px solid #000;
  border-radius: 50%;
  box-shadow: 4px 4px 0 #000;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 30px;
  color: #fff;
  cursor: pointer;
  z-index: 999;
}
.add-fab:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }

/* ç®¡ç† Modal è¼¸å…¥æ¡† */
.manage-modal-content { padding: 20px; }
.manage-modal-content input, 
.manage-modal-content textarea, 
.manage-modal-content select {
  width: 100%;
  padding: 12px;
  margin-bottom: 15px;
  border: 3px solid #000;
  font-size: 16px;
  font-weight: 800;
  background: #fff;
}
.save-btn {
  width: 100%;
  padding: 15px;
  background: #000;
  color: #fff;
  border: 3px solid #000;
  font-size: 18px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="bg-fixed"></div>

<header>ğŸ–¼ï¸ è¡Œç¨‹ä»‹ç´¹</header>

<div class="filter-bar">
  <div class="filter-btn active" onclick="filterType('all')">å…¨éƒ¨</div>
  <div class="filter-btn" onclick="filterType('spot')">æ™¯é»</div>
  <div class="filter-btn" onclick="filterType('food')">ç¾é£Ÿ</div>
  <div class="filter-btn" onclick="filterType('shopping')">è³¼ç‰©</div>
</div>

<div class="filter-bar" id="regionBar" style="border-top: none; padding-top: 0; background: rgba(255,255,255,0.6);">
  </div>

<div class="intro-grid" id="introGrid"></div>

<div class="modal" id="detailModal" onclick="if(event.target==this) closeDetail()">
  <div class="modal-content">
    <button onclick="editFromDetail()" style="position: absolute; top: 10px; right: 55px; background: #fff; border: 3px solid #000; padding: 5px 10px; font-weight: 900; box-shadow: 2px 2px 0 #000; z-index:11;">ç·¨è¼¯</button>
    <div class="close-btn" onclick="closeDetail()">Ã—</div>
    <img id="modalImg" class="modal-img" src="" alt="">
    <div class="modal-body">
      <div id="modalTag" class="tag"></div>
      <h2 id="modalTitle" style="margin: 10px 0;"></h2>
      <p id="modalDesc" class="modal-desc"></p>
      <a id="modalMap" class="map-btn" target="_blank">åœ¨ Google Maps ä¸­æŸ¥çœ‹</a>
    </div>
  </div>
</div>

<div class="modal" id="addModal" onclick="if(event.target==this) closeAddModal()">
  <div class="modal-content manage-modal-content">
    <div class="close-btn" onclick="closeAddModal()">Ã—</div>
    <h3 id="manageModalTitle">æ–°å¢æ™¯é»ä»‹ç´¹</h3>
    <select id="addType">
      <option value="spot">æ™¯é»</option>
      <option value="food">ç¾é£Ÿ</option>
      <option value="shopping">è³¼ç‰©</option>
    </select>
	<input type="text" id="addRegion" placeholder="åœ°å€ (ä¾‹å¦‚ï¼šæ–°å®¿ã€äº¬éƒ½)">
    <input type="text" id="addTitle" placeholder="åç¨±">
    <input type="text" id="addImage" placeholder="åœ–ç‰‡ç¶²å€">
    <input type="text" id="addLocation" placeholder="åœ°åœ–æœå°‹é—œéµå­—">
    <textarea id="addDescription" rows="4" placeholder="è©³ç´°ä»‹ç´¹å…§å®¹..."></textarea>
    <div class="action-row" style="display: flex; gap: 10px;">
      <button class="save-btn" onclick="saveToIntros()" style="flex: 2;">å„²å­˜åˆ°é›²ç«¯</button>
      <button id="deleteBtn" class="save-btn" onclick="deleteIntro()" style="flex: 1; background: #fff; color: #ff0000; display: none;">åˆªé™¤</button>
    </div>
  </div>
</div>

<div class="add-fab" onclick="openAddModal()">ï¼‹</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

let currentType = 'all';
let currentRegion = 'all';
let allData = []; // ç”¨ä¾†å­˜æ”¾å¾ Firebase æŠ“å–çš„åŸå§‹è³‡æ–™


const firebaseConfig = {
  apiKey: "AIzaSyASLSZHEKiQfUJU1c0sJ_9eH-6-9-1Rypc",
  authDomain: "tokyo-travel-share.firebaseapp.com",
  projectId: "tokyo-travel-share",
  storageBucket: "tokyo-travel-share.firebasestorage.app",
  messagingSenderId: "199301658742",
  appId: "1:199301658742:web:81dec31fd424e73e598757"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentEditId = null; 

/* ===== æ ¸å¿ƒåŠŸèƒ½ ===== */
function filter(type) {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', (type === 'all' && btn.innerText === 'å…¨éƒ¨') || btn.innerText.includes(type === 'spot' ? 'æ™¯é»' : type === 'food' ? 'ç¾é£Ÿ' : 'è³¼ç‰©'));
  });
  document.querySelectorAll('.intro-card').forEach(card => {
    card.style.display = (type === 'all' || card.dataset.type === type) ? 'flex' : 'none';
  });
}

function openDetail(title, type, img, desc, location) {
  document.getElementById('modalTitle').innerText = title;
  document.getElementById('modalTag').innerText = type === 'spot' ? 'æ™¯é»' : type === 'food' ? 'ç¾é£Ÿ' : 'è³¼ç‰©';
  document.getElementById('modalTag').className = 'tag ' + type;
  document.getElementById('modalImg').src = img || 'https://via.placeholder.com/300x120';
  document.getElementById('modalDesc').innerText = desc || "æš«ç„¡ä»‹ç´¹";
  document.getElementById('modalMap').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`;
  document.getElementById('detailModal').style.display = 'flex';
}

function closeDetail() { document.getElementById('detailModal').style.display = 'none'; }

function openAddModal() {
  currentEditId = null;
  document.getElementById('manageModalTitle').innerText = "æ–°å¢æ™¯é»ä»‹ç´¹";
  document.getElementById('deleteBtn').style.display = "none";
  
  // æ¸…ç©ºæ‰€æœ‰æ¬„ä½
  document.getElementById('addType').value = "spot";
  document.getElementById('addRegion').value = ""; // æ¸…ç©ºåœ°å€
  document.getElementById('addTitle').value = "";
  document.getElementById('addImage').value = "";
  document.getElementById('addLocation').value = "";
  document.getElementById('addDescription').value = "";
  
  document.getElementById('addModal').style.display = 'flex';
}
function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

/* ===== Firebase æ¸²æŸ“ ===== */
const introGrid = document.getElementById('introGrid');

function createCardElement(data, id) {
  const card = document.createElement('div');
  card.className = 'intro-card';
  card.dataset.type = data.type;
  
  // å¡ç‰‡æ¨™é¡Œé¡¯ç¤º [åœ°å€] åç¨±
  const displayTitle = data.region ? `[${data.region}] ${data.title}` : data.title;

  card.innerHTML = `
    <img src="${data.image || 'https://via.placeholder.com/300x120'}" alt="">
    <div class="intro-content">
      <div class="tag ${data.type}">${data.type === 'spot' ? 'æ™¯é»' : data.type === 'food' ? 'ç¾é£Ÿ' : 'è³¼ç‰©'}</div>
      <div class="intro-title">${displayTitle}</div>
    </div>
  `;
  card.onclick = () => {
    currentEditId = id;
    openDetail(data.title, data.type, data.image, data.description, data.location);
  };
  introGrid.appendChild(card);
}


db.collection('intros').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
  allData = [];
  snapshot.forEach(doc => {
    allData.push({ id: doc.id, ...doc.data() });
  });
  
  updateRegionButtons(); // æ›´æ–°åœ°å€æŒ‰éˆ•
  renderAllCards();      // æ¸²æŸ“å¡ç‰‡
}, err => { console.error('è¼‰å…¥å¤±æ•—', err); });


function updateRegionButtons() {
  const regionBar = document.getElementById('regionBar');
  const regions = [...new Set(allData.map(item => item.region).filter(r => r))];
  
  if (regions.length === 0) {
    regionBar.style.display = "none";
    return;
  } else {
    regionBar.style.display = "flex"; // ç¢ºä¿æ˜¯ flex æ‰èƒ½æ©«å‘æ»‘å‹•
  }
  
  let html = `<div class="filter-btn ${currentRegion === 'all' ? 'active' : ''}" onclick="filterRegion('all')">æ‰€æœ‰åœ°å€</div>`;
  regions.forEach(r => {
    html += `<div class="filter-btn ${currentRegion === r ? 'active' : ''}" onclick="filterRegion('${r}')">${r}</div>`;
  });
  
  regionBar.innerHTML = html;
}

function filterType(type) {
  currentType = type;
  updateActiveButtons('.filter-bar:first-child .filter-btn', type);
  renderAllCards();
}

function filterRegion(region) {
  currentRegion = region;
  updateActiveButtons('#regionBar .filter-btn', region);
  renderAllCards();
}

function renderAllCards() {
  introGrid.innerHTML = "";
  
  allData.forEach(data => {
    const matchType = (currentType === 'all' || data.type === currentType);
    const matchRegion = (currentRegion === 'all' || data.region === currentRegion);
    
    if (matchType && matchRegion) {
      // é€™è£¡å‘¼å«ä½ åŸæœ¬çš„æ¸²æŸ“å‡½æ•¸é‚è¼¯
      // æ³¨æ„ï¼šå› ç‚º renderIntroCard ä¹‹å‰æ˜¯å‚³å…¥ docï¼Œç¾åœ¨æˆ‘å€‘ç›´æ¥å‚³ data 
      // å»ºè­°ä¿®æ”¹ renderIntroCard æ¥å— (data, id) å…©å€‹åƒæ•¸
      createCardElement(data, data.id);
    }
  });
}

// è¼”åŠ©å‡½æ•¸ï¼šåˆ‡æ›æŒ‰éˆ•é«˜äº®
function updateActiveButtons(selector, value) {
  document.querySelectorAll(selector).forEach(btn => {
    const text = btn.innerText;
    // åˆ¤æ–·æ˜¯å¦ç¬¦åˆ
    const isAll = (value === 'all' && (text === 'å…¨éƒ¨' || text === 'æ‰€æœ‰åœ°å€'));
    const isMatch = text.includes(value);
    btn.classList.toggle('active', isAll || isMatch);
  });
}



/* ===== ç·¨è¼¯èˆ‡å„²å­˜ ===== */
function editFromDetail() {
  if (!currentEditId) return;
  closeDetail();
  document.getElementById('manageModalTitle').innerText = "ç·¨è¼¯è¡Œç¨‹ä»‹ç´¹";
  document.getElementById('deleteBtn').style.display = "block";

  db.collection('intros').doc(currentEditId).get().then(doc => {
    const data = doc.data();
    document.getElementById('addType').value = data.type;
    document.getElementById('addRegion').value = data.region || ""; // å¡«å…¥åœ°å€
    document.getElementById('addTitle').value = data.title;
    document.getElementById('addImage').value = data.image;
    document.getElementById('addLocation').value = data.location;
    document.getElementById('addDescription').value = data.description;
    
    document.getElementById('addModal').style.display = 'flex';
  });
}

function saveToIntros() {
  const data = {
    type: document.getElementById('addType').value,
    region: document.getElementById('addRegion').value, // å–å¾—åœ°å€
    title: document.getElementById('addTitle').value,
    image: document.getElementById('addImage').value,
    location: document.getElementById('addLocation').value,
    description: document.getElementById('addDescription').value,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (!data.title) { alert("è«‹è¼¸å…¥åç¨±ï¼"); return; }

  if (currentEditId) {
    db.collection('intros').doc(currentEditId).update(data).then(() => {
      closeAddModal();
    });
  } else {
    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
    db.collection('intros').add(data).then(() => {
      closeAddModal();
    });
  }
}

function deleteIntro() {
  if (!currentEditId || !confirm("ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ")) return;
  db.collection('intros').doc(currentEditId).delete().then(() => {
    alert("å·²åˆªé™¤"); closeAddModal(); closeDetail();
  });
}
</script>
</body>
</html>

