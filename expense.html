<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è¨˜å¸³ - æ—…éŠåŠ©æ‰‹</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ===== æ ¸å¿ƒï¼šé˜²æ­¢èƒŒæ™¯ç§»å‹•çš„è¨­è¨ˆ ===== */
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; font-weight: 800; -webkit-tap-highlight-color: transparent; }

html, body {
  margin: 0;
  height: 100%;
  overflow: hidden; /* é˜²æ­¢æœ€å¤–å±¤æ²å‹• */
}

.main-container {
  height: 100%;
  overflow-y: auto; /* åªåœ¨å…§å®¹å€æ²å‹• */
  -webkit-overflow-scrolling: touch; /* è®“ iOS æ²å‹•æ›´å¹³æ»‘ */
  padding-bottom: 120px;
  position: relative;
  z-index: 1;
}

.bg-fixed {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background-image: url('images/expense/expensebg.jpeg');
  background-size: cover;
  background-position: center;
  z-index: -1;
}

/* UI çµ„ä»¶ */
header { 
  padding: 16px; text-align: center; font-size: 20px; border-bottom: 3px solid #000; 
  background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
  display: flex; justify-content: space-between; align-items: center;
}

.stat-trigger-btn {
  background: #000; color: #fff; border: 2px solid #000; padding: 5px 12px; font-size: 14px; border-radius: 5px;
}

.filter-bar {
  display: flex; gap: 10px; padding: 15px; 
  background: rgba(255,255,255,0.7); border-bottom: 3px solid #000;
}
.filter-bar input, .filter-bar select { flex: 1; border: 3px solid #000; padding: 10px; font-size: 14px; background: #fff; }

/* æ™‚é–“è»¸åˆ—è¡¨ */
.list { padding: 20px 15px 20px 80px; position: relative; }
.list::before { content: ''; position: absolute; top: 0; bottom: 0; left: 38px; width: 4px; background: #000; }

.card {
  border: 3px solid #000; background: #fff; box-shadow: 4px 4px 0 #000;
  padding: 12px 15px; margin-bottom: 25px; border-radius: 12px; position: relative;
}

.time-node {
  position: absolute; left: -72px; top: 50%; transform: translateY(-50%);
  width: 55px; height: 55px; background: #ff8c00; border: 3px solid #000; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; font-size: 13px; box-shadow: 2px 2px 0 #000;
}

.card-main { display: flex; justify-content: space-between; align-items: center; }
.category-tag { display: inline-block; padding: 2px 8px; border: 2px solid #000; border-radius: 99px; font-size: 11px; background: #fde68a; }
.amount-area { text-align: right; }
.amount { font-size: 18px; }

/* æ‡¸æµ®æŒ‰éˆ• */
.add-fab { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; background: #ff8c00; border: 4px solid #000; border-radius: 50%; box-shadow: 5px 5px 0 #000; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #fff; z-index: 100; }
.rate-fab { position: fixed; bottom: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border: 3px solid #000; border-radius: 50%; box-shadow: 3px 3px 0 #000; display: flex; align-items: center; justify-content: center; font-size: 20px; z-index: 100; }

/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
.modal-content { width: 100%; max-width: 350px; background: #fff; border: 4px solid #000; box-shadow: 8px 8px 0 #000; padding: 20px; position: relative; }
.close-x { position: absolute; top: -15px; right: -15px; width: 40px; height: 40px; border: 3px solid #000; background: #fff; box-shadow: 4px 4px 0 #000; display: flex; align-items: center; justify-content: center; }

/* çµ±è¨ˆå°ˆç”¨æ¨£å¼ */
.stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; font-size: 16px; }
.stat-total-box { margin-top: 15px; padding: 15px; background: #bbf7d0; border: 3px solid #000; text-align: center; }
.stat-btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
.stat-tab { flex: 1; padding: 10px; border: 2px solid #000; background: #eee; text-align: center; cursor: pointer; }
.stat-tab.active { background: #ff8c00; color: #fff; }

.save-action-btn { width: 100%; padding: 15px; background: #000; color: #fff; border: 3px solid #000; font-size: 18px; margin-top: 10px; font-weight: 800; }
input, select, textarea { width: 100%; border: 3px solid #000; padding: 10px; margin-bottom: 10px; font-size: 16px; font-weight: 800; }
.calc-display { border: 3px solid #000; background: #f9f9f9; padding: 15px; font-size: 28px; text-align: right; margin-bottom: 15px; min-height: 65px; }
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
.calc-grid button { padding: 15px 5px; border: 2px solid #000; background: #fff; font-size: 18px; }
.curr-btn { flex: 1; min-width: 55px; padding: 8px; border: 2px solid #000; background: #fff; font-size: 12px; }
.curr-btn.active { background: #000; color: #fff; }
</style>
</head>

<body>

<div class="bg-fixed"></div>

<div class="main-container">
  <header>
    <span>ğŸ’° æ—…éŠè¨˜å¸³</span>
    <button class="stat-trigger-btn" onclick="openStatModal()">æŸ¥çœ‹æ”¯å‡º</button>
  </header>

  <div class="filter-bar">
    <input type="date" id="filterDate" min="2025-02-15" max="2025-02-23">
    <select id="filterCategory">
      <option value="">æ‰€æœ‰é¡åˆ¥</option>
      <option>é£²é£Ÿ</option><option>äº¤é€š</option><option>ç©æ¨‚</option>
      <option>è³¼ç‰©</option><option>è¶…å•†</option><option>æ‰‹ä¿¡</option>
      <option>åœè»Šè²»</option><option>å…¶ä»–</option>
    </select>
  </div>

  <div class="list" id="list"></div>
</div>

<div class="rate-fab" onclick="openRateModal()">âš™ï¸</div>
<div class="add-fab" onclick="openForm()">ï¼‹</div>

<div class="modal" id="statModal" onclick="if(event.target==this) closeStatModal()">
  <div class="modal-content">
    <div class="close-x" onclick="closeStatModal()">âœ•</div>
    <div class="stat-btn-group">
      <div class="stat-tab active" id="tabToday" onclick="switchStat('today')">ä»Šæ—¥</div>
      <div class="stat-tab" id="tabTotal" onclick="switchStat('total')">è¡Œç¨‹</div>
    </div>
    <div id="statDetail">
      </div>
  </div>
</div>

<div class="modal" id="rateModal" onclick="if(event.target==this) closeRateModal()">
  <div class="modal-content">
    <div class="close-x" onclick="closeRateModal()">âœ•</div>
    <h3 style="margin-top:0">åŒ¯ç‡è¨­å®š (å°æ‡‰ 1 MOP)</h3>
    <div id="rateInputsContainer"></div>
    <button class="save-action-btn" onclick="saveRates()">å„²å­˜åŒ¯ç‡</button>
  </div>
</div>

<div class="modal" id="formModal" onclick="if(event.target==this) closeAll()">
  <div class="modal-content">
    <div class="close-x" onclick="closeAll()">âœ•</div>
    <h3 id="formTitle" style="margin-top:0">æ–°å¢è¨˜å¸³</h3>
    <div style="display:flex; gap:10px">
      <input type="date" id="dateInput" min="2025-02-15" max="2025-02-23">
      <input type="time" id="timeInput">
    </div>
    <input placeholder="é …ç›®åç¨±" id="itemInput">
    <select id="categoryInput">
      <option>é£²é£Ÿ</option><option>äº¤é€š</option><option>ç©æ¨‚</option>
      <option>è³¼ç‰©</option><option>è¶…å•†</option><option>æ‰‹ä¿¡</option>
      <option>åœè»Šè²»</option><option>å…¶ä»–</option>
    </select>
    <textarea placeholder="å‚™è¨»å…§å®¹..." id="noteInput" rows="2"></textarea>
    <button class="save-action-btn" onclick="openCalc()">ä¸‹ä¸€æ­¥ï¼šé‡‘é¡</button>
  </div>
</div>

<div class="modal" id="calcModal" onclick="if(event.target==this) closeAll()">
  <div class="modal-content">
    <div class="close-x" onclick="closeAll()">âœ•</div>
    <div class="calc-display" id="calcDisplay">0</div>
    <div class="currency-bar" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:15px;">
      <button class="curr-btn" onclick="setCurrency('HKD')">HKD</button>
      <button class="curr-btn" onclick="setCurrency('MOP')">MOP</button>
      <button class="curr-btn" onclick="setCurrency('JPY')">JPY</button>
      <button class="curr-btn" onclick="setCurrency('TWD')">TWD</button>
      <button class="curr-btn" onclick="setCurrency('KRW')">KRW</button>
    </div>
    <div class="calc-grid">
      <button onclick="press('7')">7</button><button onclick="press('8')">8</button><button onclick="press('9')">9</button><button onclick="del()">âŒ«</button>
      <button onclick="press('4')">4</button><button onclick="press('5')">5</button><button onclick="press('6')">6</button><button onclick="clearCalc()">C</button>
      <button onclick="press('1')">1</button><button onclick="press('2')">2</button><button onclick="press('3')">3</button><button onclick="press('.')">.</button>
      <button style="grid-column: span 4" onclick="press('0')">0</button>
    </div>
    <button class="save-action-btn" style="background:#ff8c00" onclick="save()">å„²å­˜è¨˜éŒ„</button>
  </div>
</div>

<script>
/* Firebase åˆå§‹åŒ– */
const firebaseConfig = { apiKey: "AIzaSyASLSZHEKiQfUJU1c0sJ_9eH-6-9-1Rypc", authDomain: "tokyo-travel-share.firebaseapp.com", projectId: "tokyo-travel-share" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ç‹€æ…‹ */
// æ³¨æ„ï¼šç¾åœ¨åŒ¯ç‡æ˜¯ä»¥ 1 MOP ç‚ºåŸºæº–ï¼Œæ‰€ä»¥ MOP ç‚º 1
let rates = JSON.parse(localStorage.getItem('travel_rates')) || { "HKD": 1.03, "MOP": 1, "JPY": 0.052, "TWD": 0.25, "KRW": 0.0058 };
let editId = null, calcValue = "", currentCurrency = "MOP", currentStatMode = 'today';
let allRecords = [];

const todayStr = new Date().toISOString().split("T")[0];
const defaultDate = (todayStr >= "2025-02-15" && todayStr <= "2025-02-23") ? todayStr : "2025-02-15";
dateInput.value = defaultDate; filterDate.value = defaultDate;
timeInput.value = new Date().toTimeString().slice(0,5);

/* æ•¸æ“šè¼‰å…¥ï¼šç›£è½æ‰€æœ‰ç›¸é—œç´€éŒ„ */
db.collection("accounts").where("date", ">=", "2025-02-15").where("date", "<=", "2025-02-23").onSnapshot(s => {
  allRecords = [];
  s.forEach(doc => allRecords.push({ id: doc.id, ...doc.data() }));
  renderList();
});

filterDate.onchange = renderList;
filterCategory.onchange = renderList;

function renderList() {
  const list = document.getElementById('list');
  list.innerHTML = "";
  const filtered = allRecords.filter(r => r.date === filterDate.value && (!filterCategory.value || r.category === filterCategory.value));
  
  filtered.sort((a,b) => b.time.localeCompare(a.time)).forEach(d => {
    const rate = rates[d.currency] || 1;
    const subtotalMOP = d.amount * rate;
    list.innerHTML += `
      <div class="card" onclick="edit('${d.id}')">
        <div class="time-node">${d.time}</div>
        <div class="card-main">
          <div style="flex:1">
            <strong>${d.item}</strong><br><span class="category-tag">${d.category}</span>
          </div>
          <div class="amount-area">
            <div class="amount">${d.currency} ${d.amount.toLocaleString()}</div>
            <small style="color:#888">â‰ˆ MOP ${subtotalMOP.toFixed(1)}</small>
          </div>
        </div>
        <div style="text-align:right; margin-top:8px; border-top:1px dashed #eee; padding-top:5px">
          <button class="delete-btn" style="background:none; border:none; color:red; font-size:12px;" onclick="event.stopPropagation();delRec('${d.id}')">åˆªé™¤</button>
        </div>
      </div>`;
  });
}

/* çµ±è¨ˆåŠŸèƒ½ */
function openStatModal() {
  document.getElementById('statModal').style.display = 'flex';
  switchStat('today');
}

function switchStat(mode) {
  currentStatMode = mode;
  document.getElementById('tabToday').classList.toggle('active', mode === 'today');
  document.getElementById('tabTotal').classList.toggle('active', mode === 'total');
  
  const records = mode === 'today' ? allRecords.filter(r => r.date === filterDate.value) : allRecords;
  
  // åˆ†å¹£ç¨®çµ±è¨ˆ
  const totals = {};
  let finalMOP = 0;
  records.forEach(r => {
    totals[r.currency] = (totals[r.currency] || 0) + r.amount;
    finalMOP += (r.amount * (rates[r.currency] || 1));
  });

  let html = `<div style="margin-bottom:10px; color:#666">${mode==='today'?filterDate.value:'2/15 - 2/23'} æ”¯å‡ºæ¸…å–®ï¼š</div>`;
  for(let curr in totals) {
    html += `<div class="stat-row"><span>${curr} ç¸½è¨ˆ</span><span>${totals[curr].toLocaleString()}</span></div>`;
  }
  html += `<div class="stat-total-box"><strong>æœ€çµ‚çµç®—ä¼°è¨ˆ</strong><br><span style="font-size:24px">MOP ${finalMOP.toFixed(1)}</span></div>`;
  
  document.getElementById('statDetail').innerHTML = html;
}

function closeStatModal() { document.getElementById('statModal').style.display = 'none'; }

/* åŸºç¤åŠŸèƒ½ (åŒ¯ç‡ã€è¡¨å–®) */
function openRateModal() {
  const container = document.getElementById('rateInputsContainer');
  container.innerHTML = "";
  for (let c in rates) {
    container.innerHTML += `<div class="rate-input-group"><label>${c}</label><input type="number" step="0.0001" id="r_${c}" value="${rates[c]}" ${c==='MOP'?'disabled':''}></div>`;
  }
  document.getElementById('rateModal').style.display='flex';
}
function saveRates() {
  for (let c in rates) if(c!=='MOP') rates[c] = parseFloat(document.getElementById(`r_${c}`).value) || 1;
  localStorage.setItem('travel_rates', JSON.stringify(rates));
  document.getElementById('rateModal').style.display='none';
  renderList();
}

function openForm() { editId = null; formTitle.innerText="æ–°å¢è¨˜å¸³"; itemInput.value=""; calcValue=""; currentCurrency="MOP"; formModal.style.display="flex"; }
function openCalc() { formModal.style.display="none"; calcModal.style.display="flex"; updateCalcUI(); }
function closeAll() { formModal.style.display="none"; calcModal.style.display="none"; }
function press(v) { if(v==='.' && calcValue.includes('.')) return; calcValue+=v; updateCalcUI(); }
function del() { calcValue = calcValue.slice(0,-1); updateCalcUI(); }
function clearCalc() { calcValue = ""; updateCalcUI(); }
function setCurrency(c) { currentCurrency = c; updateCalcUI(); }
function updateCalcUI() {
  document.getElementById('calcDisplay').innerText = currentCurrency + " " + (calcValue || "0");
  document.querySelectorAll('.curr-btn').forEach(b => b.classList.toggle('active', b.innerText === currentCurrency));
}
function save() {
  const data = { date: dateInput.value, time: timeInput.value, item: itemInput.value, category: categoryInput.value, note: noteInput.value, amount: parseFloat(calcValue), currency: currentCurrency };
  const p = editId ? db.collection("accounts").doc(editId).update(data) : db.collection("accounts").add(data);
  p.then(() => closeAll());
}
function edit(id) {
  const v = allRecords.find(r => r.id === id);
  editId = id; formTitle.innerText="ç·¨è¼¯è¨˜å¸³";
  dateInput.value=v.date; timeInput.value=v.time; itemInput.value=v.item; categoryInput.value=v.category; noteInput.value=v.note;
  calcValue=v.amount.toString(); currentCurrency=v.currency;
  formModal.style.display="flex";
}
function delRec(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.collection("accounts").doc(id).delete(); }
function closeRateModal() { document.getElementById('rateModal').style.display='none'; }
</script>
</body>
</html>
