<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¡Œç¨‹ä»‹ç´¹ Firebase åŒæ­¥ç‰ˆ</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
* { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans TC", sans-serif; font-weight: 800; }
body { margin:0; background: radial-gradient(#eaeaea 1px, transparent 1px), radial-gradient(#f5f5f5 1px, transparent 1px); background-size: 6px 6px; background-position: 0 0, 3px 3px; }
header { padding: 14px; text-align:center; font-size:20px; }
.region-bar { display:flex; overflow-x:auto; gap:10px; padding:10px; justify-content:center; }
.region-btn { min-width:90px; text-align:center; padding:10px; border:3px solid #000; background:#fff; box-shadow:4px 4px 0 #000; cursor:pointer; white-space:nowrap; }
.region-btn.active { background:#ff8c00; color:#fff; }
.category-select { position:fixed; top:70px; right:10px; width:140px; padding:8px; border:3px solid #000; font-weight:800; font-size:14px; background:#fff; box-shadow:4px 4px 0 #000; }
.timeline { padding:16px; margin-right:160px; }
.event { position:relative; margin-left:22px; margin-bottom:16px; padding:14px; border:3px solid #000; border-radius:14px; background:#fff; box-shadow:4px 4px 0 #000; cursor:pointer; }
.event::before { content:""; position:absolute; left:-26px; top:18px; width:12px; height:12px; background:#ff8c00; border:3px solid #000; border-radius:50%; }
.time { font-size:15px; }
.place { font-size:14px; margin-top:4px; }
.note { font-size:13px; margin-top:6px; color:#444; }
.add-btn { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:90%; padding:14px; font-size:18px; border:3px solid #000; background:#ff8c00; color:#fff; box-shadow:5px 5px 0 #000; }

/* Modal */
.modal { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:none; align-items:center; justify-content:center; }
.modal-content { width:90%; background:#fff; border:3px solid #000; box-shadow:6px 6px 0 #000; padding:16px; }
.modal-content h3 { margin-top:0; }
input, textarea, select { width:100%; margin-bottom:10px; padding:10px; border:3px solid #000; font-size:16px; }
.checkbox-row { display:flex; gap:10px; margin-bottom:10px; }
.action-row { display:flex; gap:10px; }
.save-btn { flex:1; padding:12px; border:3px solid #000; background:#000; color:#fff; }
.delete-btn { flex:1; padding:12px; border:3px solid #000; background:#fff; color:#000; }
.close-btn {
  position: absolute;
  top: 8px;
  right: 10px;
  font-size: 22px;
  font-weight: 800;
  cursor: pointer;
  color: #000;
}
.close-btn:hover {
  color: #ff8c00;
}
</style>
</head>

<body>

<header>ğŸ“– è¡Œç¨‹ä»‹ç´¹</header>

<div class="region-bar" id="regionBar"></div>
<select id="categorySelect" class="category-select">
  <option value="">æ‰€æœ‰é¡åˆ¥</option>
  <option value="æ™¯é»">æ™¯é»</option>
  <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
  <option value="è³¼ç‰©">è³¼ç‰©</option>
  <option value="å…¶ä»–">å…¶ä»–</option>
</select>

<div class="timeline" id="timeline"></div>
<button class="add-btn" onclick="openAdd()">ï¼‹ æ–°å¢è¡Œç¨‹</button>

<!-- Modal -->
<div class="modal" id="modal" onclick="closeModal(event)">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">Ã—</span>
    <h3 id="modalTitle">æ–°å¢è¡Œç¨‹</h3>
    <input id="titleInput" placeholder="è¡Œç¨‹">
    <input id="regionInput" placeholder="åœ°å€">
    <input id="placeInput" placeholder="åœ°é»">
    <select id="categoryInput">
      <option value="æ™¯é»">æ™¯é»</option>
      <option value="ç¾é£Ÿ">ç¾é£Ÿ</option>
      <option value="è³¼ç‰©">è³¼ç‰©</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>
    <textarea id="introInput" placeholder="ä»‹ç´¹"></textarea>
    <div class="checkbox-row">
      <label><input type="checkbox" id="needTicketInput"> éœ€è¦æå‰è³¼ç¥¨</label>
      <label><input type="checkbox" id="hasTicketInput"> å·²è³¼ç¥¨</label>
    </div>
    <div class="action-row">
      <button class="save-btn" onclick="save()">å„²å­˜</button>
      <button class="delete-btn" onclick="remove()">åˆªé™¤</button>
    </div>
  </div>
</div>

<script>
/* ===== Firebase åˆå§‹åŒ– ===== */
const firebaseConfig = {
  apiKey: "AIzaSyASLSZHEKiQfUJU1c0sJ_9eH-6-9-1Rypc",
  authDomain: "tokyo-travel-share.firebaseapp.com",
  projectId: "tokyo-travel-share",
  storageBucket: "tokyo-travel-share.firebasestorage.app",
  messagingSenderId: "199301658742",
  appId: "1:199301658742:web:81dec31fd424e73e598757"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== å€åŸŸé¸å–®å‹•æ…‹ç”Ÿæˆ ===== */
let regions = [];
let currentRegion = "";
let currentCategory = "";

let editId = null; // Firestore doc ID

const regionBar = document.getElementById("regionBar");
const categorySelect = document.getElementById("categorySelect");
categorySelect.onchange = ()=>{
  currentCategory = categorySelect.value;
  render();
};
const timeline = document.getElementById("timeline");

/* ===== Modal å…ƒç´  ===== */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const titleInput = document.getElementById("titleInput");
const regionInput = document.getElementById("regionInput");
const placeInput = document.getElementById("placeInput");
const categoryInput = document.getElementById("categoryInput");
const introInput = document.getElementById("introInput");
const needTicketInput = document.getElementById("needTicketInput");
const hasTicketInput = document.getElementById("hasTicketInput");

/* ===== è¨‚é–± Firestore ===== */
let unsubscribe = null;
subscribeToEvents();

function subscribeToEvents(){
  if(unsubscribe) unsubscribe();
  unsubscribe = db.collection("itinerary_intro")
    .orderBy("createdAt")
    .onSnapshot(snapshot=>{
      const arr=[];
      snapshot.forEach(doc=>{
        arr.push({ id: doc.id, ...doc.data() });
      });
      updateRegions(arr);
      render(arr);
    });
}

let allEvents = []; // ä¿ç•™å®Œæ•´è³‡æ–™

function subscribeToEvents(){
  if(unsubscribe) unsubscribe();
  unsubscribe = db.collection("itinerary_intro")
    .orderBy("createdAt")
    .onSnapshot(snapshot=>{
      allEvents = [];
      snapshot.forEach(doc=>{
        allEvents.push({ id: doc.id, ...doc.data() });
      });
      updateRegions();
      render();
    });
}


/* ===== æ›´æ–°å€åŸŸé¸å–® ===== */
function updateRegions(){
  const prevRegion = currentRegion || "";
  regions = [...new Set(allEvents.map(e=>e.region))];
  regionBar.innerHTML="";
  regions.forEach(r=>{
    const b = document.createElement("div");
    b.className="region-btn";
    b.innerText = r;
    b.onclick = ()=>{
      currentRegion = r;
      render();
    };
    regionBar.appendChild(b);
  });
  // å¦‚æœä¹‹å‰é¸çš„åœ°å€é‚„å­˜åœ¨ï¼Œä¿æŒé¸ä¸­ï¼Œå¦å‰‡é¸ç¬¬ä¸€å€‹
  if(!regions.includes(prevRegion)) currentRegion = regions[0] || "";
}

/* ===== Render è¡Œç¨‹ ===== */
function render(){
  let displayEvents = allEvents;

  if(currentRegion) displayEvents = displayEvents.filter(e=> e.region===currentRegion);
  if(currentCategory) displayEvents = displayEvents.filter(e=> e.category===currentCategory);

  // é«˜äº®å€åŸŸæŒ‰éˆ•
  document.querySelectorAll(".region-btn").forEach(b=>{
    b.classList.toggle("active", b.innerText===currentRegion);
  });

  timeline.innerHTML="";
  displayEvents.forEach(e=>{
    const div = document.createElement("div");
    div.className="event";
    div.onclick = ()=>openEdit(e.id, e);
    div.innerHTML=`
      <div class="time">è¡Œç¨‹ï¼š${e.title}</div>
      <div class="place">åœ°é»ï¼šğŸ“ ${e.place}</div>
      <div class="note">é¡åˆ¥ï¼š${e.category}</div>
      <div class="note">ä»‹ç´¹ï¼š${e.intro}</div>
      <div class="note">éœ€è¦æå‰è³¼ç¥¨ï¼š${e.needTicket?"âœ…":"âŒ"}</div>
      <div class="note">å·²è³¼ç¥¨ï¼š${e.hasTicket?"âœ…":"âŒ"}</div>
    `;
    timeline.appendChild(div);
  });
}

/* ===== Modal æ“ä½œ ===== */
function openAdd(){
  editId=null;
  modalTitle.innerText="æ–°å¢è¡Œç¨‹";
  titleInput.value=regionInput.value=placeInput.value=introInput.value="";
  categoryInput.value="æ™¯é»";
  needTicketInput.checked=false;
  hasTicketInput.checked=false;
  modal.style.display="flex";
}

function openEdit(id, data){
  editId=id;
  modalTitle.innerText="ç·¨è¼¯è¡Œç¨‹";
  titleInput.value=data.title;
  regionInput.value=data.region;
  placeInput.value=data.place;
  categoryInput.value=data.category;
  introInput.value=data.intro;
  needTicketInput.checked=!!data.needTicket;
  hasTicketInput.checked=!!data.hasTicket;
  modal.style.display="flex";
}

function save(){
  const e = {
    title: titleInput.value,
    region: regionInput.value,
    place: placeInput.value,
    category: categoryInput.value,
    intro: introInput.value,
    needTicket: needTicketInput.checked,
    hasTicket: hasTicketInput.checked,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(editId){
    db.collection("itinerary_intro").doc(editId).set(e);
  } else {
    db.collection("itinerary_intro").add(e);
  }
  modal.style.display="none";
}

function remove(){
  if(editId){
    db.collection("itinerary_intro").doc(editId).delete();
    modal.style.display="none";
  }
}

function closeModal(ev){
  if(ev.target.id==="modal") modal.style.display="none";
}
</script>

</body>
</html>
